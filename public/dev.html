<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dev Console - Supabase Auth + Conversations</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; margin: 0; background: #0b0b0c; color: #e5e7eb; }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .grid { display: grid; grid-template-columns: 320px 1fr; gap: 16px; }
    .card { background: #121316; border: 1px solid #1f2126; border-radius: 10px; }
    .card h3 { margin: 0; padding: 12px 14px; border-bottom: 1px solid #1f2126; font-size: 14px; color: #cbd5e1; }
    .section { padding: 14px; }
    .row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    input, button, select { background: #0f1115; border: 1px solid #2a2e36; color: #e5e7eb; border-radius: 8px; padding: 10px 12px; font-size: 13px; }
    input::placeholder { color: #6b7280; }
    button { background: #1f2937; cursor: pointer; }
    button.primary { background: #2563eb; border-color: #2563eb; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    ul { list-style: none; padding: 0; margin: 0; }
    li { padding: 8px 10px; border-bottom: 1px solid #1f2126; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    li:hover { background: #0f1115; }
    .active { background: #0f1115; border-left: 2px solid #2563eb; }
    .messages { height: 520px; overflow: auto; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .bubble { max-width: 70%; padding: 10px 12px; border-radius: 10px; border: 1px solid #1f2126; white-space: pre-wrap; }
    .user { align-self: flex-end; background: #0b1020; border-color: #1b2b5e; }
    .assistant { align-self: flex-start; background: #0f1115; }
    .row-right { display: flex; gap: 8px; align-items: center; justify-content: flex-end; }
    small { color: #94a3b8; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 style="margin:0 0 16px">Dev Console <small id="status" style="margin-left:8px;color:#94a3b8;font-weight:400"></small></h2>
    <div class="grid">
      <div class="card">
        <h3>Auth</h3>
        <div class="section">
          <div class="row"><input id="sb-url" placeholder="Supabase URL" style="width:100%"></div>
          <div class="row"><input id="sb-key" placeholder="Anon Key" style="width:100%"></div>
          <div class="row">
            <button id="save-creds">Save</button>
            <button id="init" class="primary">Init</button>
          </div>
          <div class="row"><input id="email" placeholder="Email for magic link" style="width:100%"></div>
          <div class="row">
            <button id="magic-link">Send Magic Link</button>
            <button id="google" class="primary">Sign in with Google</button>
          </div>
          <div class="row">
            <small id="user-info">Not signed in</small>
            <button id="signout" style="margin-left:auto">Sign out</button>
          </div>
        </div>
        <h3 style="border-top:1px solid #1f2126">Conversations</h3>
        <div class="section">
          <div class="row">
            <button id="create-conv" class="primary">New conversation</button>
            <button id="refresh">Refresh</button>
          </div>
          <ul id="conv-list"></ul>
        </div>
      </div>
      <div class="card">
        <h3>Messages</h3>
        <div class="messages" id="messages"></div>
        <div class="section">
          <div class="row">
            <input id="input" placeholder="Type a message..." style="flex:1">
          </div>
          <div class="row row-right">
            <select id="mode">
              <option value="stream">Stream</option>
              <option value="sync">Non-streaming</option>
            </select>
            <button id="send" class="primary">Send</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Hardcode your Supabase project here for dev convenience
    const HARDCODED_SUPABASE_URL = 'https://iiolvvdnzrfcffudwocp.supabase.co';
    const HARDCODED_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlpb2x2dmRuenJmY2ZmdWR3b2NwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MjE4MDAsImV4cCI6MjA3MzA5NzgwMH0.2-e8Scn26fqsR11h-g4avH8MWybwLTtcf3fCN9qAgVw';

    let supabaseClient = null;
    let accessToken = null;
    let currentConversation = null;
    let messagesSub = null;

    const $ = (id) => document.getElementById(id);
    const api = (path, opts={}) => fetch(`/api${path}`, {
      ...opts,
      headers: {
        'Content-Type': 'application/json',
        ...(opts.headers || {}),
        ...(accessToken ? { Authorization: `Bearer ${accessToken}` } : { 'x-dev-user-id': '11111111-1111-1111-1111-111111111111' }),
      },
    });

    function saveCreds() {
      localStorage.setItem('sb_url', $('sb-url').value.trim());
      localStorage.setItem('sb_key', $('sb-key').value.trim());
      alert('Saved');
    }

    function loadCreds() {
      // Force the correct project URL and key; ignore prior saved values to avoid dashboard URL mistakes
      $('sb-url').value = HARDCODED_SUPABASE_URL || '';
      $('sb-key').value = HARDCODED_SUPABASE_ANON_KEY || '';
      localStorage.setItem('sb_url', $('sb-url').value);
      localStorage.setItem('sb_key', $('sb-key').value);
    }

    let inited = false;
    async function initSupabase(force=false) {
      if (inited && !force) return;
      const url = $('sb-url').value.trim();
      const key = $('sb-key').value.trim();
      if (!url || !key) return alert('Set URL and Anon key');
      // Guard against dashboard URLs which cause 404 websocket handshakes
      if (url.includes('supabase.com/')) {
        alert('Invalid Supabase URL. Use your project URL like https://YOUR_REF.supabase.co');
        return;
      }
      $('status').textContent = 'initializingâ€¦';
      supabaseClient = window.supabase.createClient(url, key);
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) onSession(session);
      supabaseClient.auth.onAuthStateChange((_event, session) => {
        if (session) onSession(session); else onSignOut();
      });
      console.log('Supabase initialized');
      $('status').textContent = 'connected';
      inited = true;
    }

    function onSession(session) {
      accessToken = session?.access_token || null;
      $('user-info').textContent = session?.user?.email || session?.user?.id || 'Signed in';
      loadConversations();
    }

    function onSignOut() {
      accessToken = null;
      $('user-info').textContent = 'Not signed in';
      $('conv-list').innerHTML = '';
      $('messages').innerHTML = '';
      currentConversation = null;
      if (messagesSub) { messagesSub.unsubscribe(); messagesSub = null; }
    }

    async function sendMagicLink() {
      const email = $('email').value.trim();
      if (!email) return alert('Enter email');
      const { error } = await supabaseClient.auth.signInWithOtp({
        email,
        options: {
          emailRedirectTo: `${location.origin}/dev.html`
        }
      });
      if (error) alert(error.message); else alert('Check your email');
    }

    async function signInWithGoogle() {
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: `${location.origin}/dev.html`,
          queryParams: { prompt: 'select_account' }
        }
      });
      if (error) alert(error.message);
    }

    async function signOut() {
      await supabaseClient.auth.signOut();
    }

    async function loadConversations() {
      const res = await api('/conversations');
      const data = await res.json();
      const list = $('conv-list');
      list.innerHTML = '';
      (data.conversations || []).forEach(c => {
        const li = document.createElement('li');
        li.textContent = c.title || c.id;
        if (currentConversation?.id === c.id) li.classList.add('active');
        li.onclick = () => selectConversation(c);
        const sm = document.createElement('small'); sm.textContent = new Date(c.updated_at || c.created_at).toLocaleString();
        li.appendChild(sm);
        list.appendChild(li);
      });
    }

    async function selectConversation(conv) {
      currentConversation = conv;
      await loadMessages();
      subscribeMessagesRealtime();
      loadConversations();
    }

    async function createConversation() {
      try {
        const res = await api('/conversations', { method: 'POST', body: JSON.stringify({}) });
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch { data = { raw: text }; }
        if (res.ok && data.conversation) {
          console.log('Created conversation', data.conversation);
          await loadConversations();
          await selectConversation(data.conversation);
          alert(`Conversation created: ${data.conversation.id}`);
        } else {
          alert((data && (data.error || data.message || data.raw)) || 'Failed to create conversation');
        }
      } catch (e) {
        alert('Request failed: ' + e.message);
      }
    }

    async function loadMessages() {
      $('messages').innerHTML = '';
      if (!currentConversation) return;
      const res = await api(`/messages?conversation_id=${encodeURIComponent(currentConversation.id)}`);
      const data = await res.json();
      (data.messages || []).forEach(renderMessageRow);
      $('messages').scrollTop = $('messages').scrollHeight;
    }

    function renderMessageRow(m) {
      const div = document.createElement('div');
      div.className = `bubble ${m.role}`;
      const val = m?.content?.value ?? '';
      div.textContent = typeof val === 'string' ? val : JSON.stringify(val);
      $('messages').appendChild(div);
    }

    let messagesPoll = null;
    function subscribeMessagesRealtime() {
      if (messagesSub) { messagesSub.unsubscribe(); messagesSub = null; }
      if (messagesPoll) { clearInterval(messagesPoll); messagesPoll = null; }
      if (!currentConversation) return;
      if (accessToken) {
        messagesSub = supabaseClient.channel('realtime:messages')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'messages', filter: `conversation_id=eq.${currentConversation.id}` }, payload => {
            if (payload.eventType === 'INSERT') renderMessageRow(payload.new);
          })
          .subscribe();
      } else {
        // Dev fallback: poll messages since Realtime requires auth for RLS
        messagesPoll = setInterval(loadMessages, 1000);
      }
    }

    async function sendMessage() {
      if (!currentConversation) return alert('Create/select a conversation first');
      const text = $('input').value.trim();
      if (!text) return;
      $('input').value = '';
      const mode = $('mode').value;
      if (mode === 'sync') {
        const res = await api('/messages', { method: 'POST', body: JSON.stringify({ conversation_id: currentConversation.id, message: text, source: 'web' }) });
        const data = await res.json();
        if (data.error) alert(data.error);
        await loadMessages();
      } else {
        const res = await fetch('/api/messages/stream', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(accessToken ? { Authorization: `Bearer ${accessToken}` } : { 'x-dev-user-id': '11111111-1111-1111-1111-111111111111' })
          },
          body: JSON.stringify({ conversation_id: currentConversation.id, message: text, source: 'web' })
        });
        if (!res.ok) {
          const err = await res.text();
          alert(err);
          return;
        }
        // Optional: read stream just to know when it ends
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value);
          // no-op; UI updates via Realtime
        }
        await loadMessages();
      }
    }

    // Wire UI
    $('save-creds').onclick = saveCreds;
    $('init').onclick = () => initSupabase(true);
    $('magic-link').onclick = sendMagicLink;
    $('google').onclick = signInWithGoogle;
    $('signout').onclick = signOut;
    $('create-conv').onclick = createConversation;
    $('refresh').onclick = loadConversations;
    $('send').onclick = sendMessage;
    loadCreds();
    // Auto-init on load
    initSupabase(false).catch(err => { $('status').textContent = 'init failed'; console.error(err); });
  </script>
</body>
</html>


